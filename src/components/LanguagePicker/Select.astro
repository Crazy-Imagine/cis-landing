---
import { langFlags, languages } from '@/i18n/ui';
import { getLangFromUrl } from '@/i18n/utils';

const lang = getLangFromUrl(Astro.url);
---

<label>
  <select
    id="language-picker"
    class="hidden border-none bg-transparent font-nexaLight uppercase text-white lg:inline-block"
  >
    {
      Object.keys(languages).map((langCode) => (
        <option
          value={langCode}
          selected={lang === langCode}
          class="flex items-center bg-transparent"
        >
          {langCode.toUpperCase()}
          {langFlags[langCode as 'en' | 'es']}
        </option>
      ))
    }
  </select>
</label>

<script>
  document.addEventListener('astro:page-load', () => {
    const languagePicker = document.getElementById('language-picker');

    if (!languagePicker) return;

    languagePicker.addEventListener('change', (event: any) => {
      const lang = event.target.value;
      const url = window.location.pathname;

      if (url.startsWith('/es') && lang === 'es') return;

      if (!url.startsWith('/es') && lang === 'en') return;

      let newUrl;
      if (url.startsWith('/es') && lang === 'en') {
        const isHomePage = url === '/es';
        newUrl = url.replace('/es', isHomePage ? '/' : '');
      } else {
        if (url === '/') {
          newUrl = `/${lang}`;
        } else {
          newUrl = `/${lang}${url}`;
        }
      }

      window.location.href = newUrl;
    });
  });
</script>
