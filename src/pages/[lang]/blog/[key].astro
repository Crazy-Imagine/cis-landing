---
import { Image } from 'astro:assets';
import { marked } from 'marked';
import Layout from '@/layouts/Layout.astro';
import RecentlyPosted from '@/components/RecentlyPosted.astro';
import ResponsiveContainer from '@/components/ResponsiveContainer.astro';
import Typography from '@/components/Typography.astro';
import fetchApi from '@/lib/strapi';
import type { ArticleAttributes, ArticleCollection } from '@/types/strapi/Article';

export async function getStaticPaths() {
  const enArticlesPromise = fetchApi<ArticleCollection>({
    endpoint: 'articles',
    params: {
      locale: 'en',
      fields: ['title', 'description', 'content', 'Key', 'locale'],
      populate: {
        category: {
          fields: ['name'],
        },
        author: {
          fields: ['name'],
        },
        image: {
          fields: ['url', 'width', 'height', 'formats'],
        },
      },
      filters: {
        status: {
          $sq: 'published',
        },
      },
      sort: {
        createdAt: 'desc',
      },
    },
  });
  const esArticlesPromise = fetchApi<ArticleCollection>({
    endpoint: 'articles',
    params: {
      locale: 'es',
      fields: ['title', 'description', 'content', 'Key', 'locale'],
      populate: {
        category: {
          fields: ['name'],
        },
        author: {
          fields: ['name'],
        },
        image: {
          fields: ['url', 'width', 'height', 'formats'],
        },
      },
      filters: {
        status: {
          $sq: 'published',
        },
      },
      sort: {
        createdAt: 'desc',
      },
    },
  });

  const [enArticles, esArticles] = await Promise.all([enArticlesPromise, esArticlesPromise]);

  return [...enArticles.data, ...esArticles.data].map(({ attributes }) => ({
    params: { lang: attributes.locale, key: attributes.Key },
    props: { attributes },
  }));
}

interface Props {
  attributes: ArticleAttributes;
}

const { attributes } = Astro.props;

const {
  category: {
    data: { attributes: category },
  },
  author: {
    data: { attributes: author },
  },
  image: {
    data: [image], // TODO: Image must return alt text
  },
  ...article
} = attributes;

const content = marked(article.content);
---

<Layout>
  <ResponsiveContainer>
    <div class="mb-12">
      <Typography
        as="span"
        variant="caption"
        class="rounded-md bg-primary px-5 py-3.5 uppercase text-white"
      >
        {category.name}
      </Typography>
    </div>

    <Typography as="h1" variant="blogTitle" class="text-primary">{article.title}</Typography>

    <Typography
      as="p"
      variant="caption"
      class="my-10 border-l-2 border-primary py-2.5 pl-5 text-primary"
    >
      {author.name}
    </Typography>

    <Typography as="p" variant="paragraph" class="text-grayish">
      {article.description}
    </Typography>
  </ResponsiveContainer>

  <Image
    src={image.attributes.url}
    alt={article.title}
    width={image.attributes.width}
    height={image.attributes.height}
  />

  <ResponsiveContainer class="flex flex-col gap-10 xl:flex-row xl:gap-40">
    <article class="blog-content text-[#4f4f4f]" set:html={content} />

    <RecentlyPosted />
  </ResponsiveContainer>
</Layout>

<style is:global>
  article.blog-content {
    * {
      @apply font-roboto text-base md:text-xl;
    }

    h1,
    h2,
    h3,
    h4,
    h5,
    h6 {
      @apply mb-2.5 font-nexaBold text-xl md:text-2xl;
    }

    p {
      @apply mb-8;
    }

    pre {
      @apply mb-8 w-full max-w-full overflow-x-hidden;
    }

    code {
      @apply inline-block w-full max-w-full overflow-x-scroll;
    }

    img {
      @apply my-10;
    }

    ul,
    ol {
      @apply pl-5  md:pl-10;
      list-style: initial;

      & li {
        @apply mb-2.5;
      }
    }
  }
</style>
